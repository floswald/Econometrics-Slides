---
title: "ScPoEconometrics"
subtitle: "Session 2"
author: "Florian Oswald"
date: "SciencesPo Paris </br> `r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default, "../css/scpo.css", "../css/scpo-fonts.css"]
    nature:
      beforeInit: ["../js/ru_xaringan.js"]
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    includes:
      in_header: "../libs/partials/header.html"
---

layout: true

<div class="my-footer"><img src="../img/logo/ScPo-shield.png" style="height: 60px;"/></div> 

---

```{r setup, include=FALSE,warning=FALSE,message=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  dev = "svg",
  cache = TRUE,
  fig.align = "center"
  #fig.width = 11,
  #fig.height = 5
)

# define vars
om = par("mar")
lowtop = c(om[1],om[2],1,om[4])

```

# Working With Data


* Econometrics is about Data.

* In these slides we will start to look at this.

* Let's first all load a dataset with this command:
    ```{r}
    data("mpg",package="ggplot2")
    ```

--

* Here are the first 6 rows
    ```{r}
    head(mpg)
    ```

---

# The `mpg` dataset

* How many rows and columns?
    ```{r}
    dim(mpg)
    ```

* `tail` gives you the last (6) rows.
    ```{r,eval = FALSE}
    tail(mpg)
    ```

* `names` gives the column names.


---

# The `mpg` dataset: datatypes

* It's important to know how the data is stored.

* We can use `str` for that:

```{r}
str(mpg)
```

---

# Summarizing Data


* One can learn only a limited amount from **looking** at a `data.frame`. `r emo::ji("mag")`

--

* Even if you *could* see all rows of the dataset, you would not know very much **about it**.

--

* We need to **summarize** the data for us to learn from it.

--

* In general, we can compute summary statistics, or visualize the data with plots.

--

* Let's start with some statistics first!

--

* Let's look at two features: *central tendency* and *spread*.

---

# Central Tendency


.pull-left[
1. `mean(x)`: the average of all values in `x`.
    $$\bar{x} = \frac{1}{N}\sum_{i=1}^N x_i$$

1. `median`: the value $x_j$ below and above which 50% of the values in `x` lie. $m$ is the median if
    $$\Pr(X \leq m) \geq 0.5 \text{ and } \Pr(X \geq m) \geq 0.5$$
1. The median is robust against *outliers*. `r emo::ji("thinking")`? (later).
]

--

.pull-right[
```{r}
x <- c(1,2,2,2,2,100)
mean(x)
mean(x) == sum(x) / length(x)
```
```{r, fig.height=3,echo = FALSE}
# om = par("mar")
# par(mar = c(3,1,1,1))
boxplot(x,horizontal = TRUE,main = "Boxplot of x (more on that later!)")
# par(mar = om)
```
```{r}
median(x)
```
]

---

# Spread

.pull-left[
* Another interesting feature is how much a variable is *spread out* about it's center (the mean in this case).

* The *variance* is such a measure.
    $$Var(X) = E[(X-\mu)^2]$$
    
* Consider two Normal Distributions with equal mean at `0`:
    
]

--

.pull-right[
```{r,echo = FALSE,fig.height=4,message = FALSE,warning = FALSE}
library(ggplot2)
ggplot(data = data.frame(x = c(-5, 5)), aes(x)) +
  stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 1), aes(color = "1"), size = 2) + ylab("") + scale_y_continuous(breaks = NULL) + theme_bw() +
  stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 2), aes(color = "4"), size = 2) + scale_color_manual("Variance:", values = c("red","blue")) + theme(text = element_text(size=20))
```

* Compute with:

```{r,eval = FALSE}
    var(x)
    range(x)   # range
    ```
]
---

# The `table` function

* `table(x)` is a useful function that counts the occurence of each unique value in `x`:
    ```{r}
    table(x)
    table(mpg$trans)
    ```

---

# Crosstables


* Given two vectors, `table` produces a contingency table:
    ```{r}
    table(mpg$trans,mpg$drv)
    ```

--

* with `prop.table`, we can get proportions:
    ```{r,eval=FALSE}
    prop.table(table(mpg$trans,mpg$drv),margin=2)
    ```

---
layout: false
class: title-slide-section-red, middle

# Plotting



---
layout: true

<div class="my-footer"><img src="../img/logo/ScPo-shield.png" style="height: 60px;"/></div> 

---

# Plotting

.pull-left[
* `R` base plotting is fairly good.

* There is an extremely powerful alternative in package `ggplot2`. We'll see both.

* First example: *histograms*. A histogram counts how many obserations fall within a certain bin.
]

--

.pull-right[
```{r,fig.align='center',fig.height=4.5}
hist(mpg$cty)
```
]

---

# A Nicer Histogram


.pull-left[
* We can give additional arguments to `hist`.

* Look at `?hist` for more.

```{r,fig.height=4.5,eval=FALSE}
hist(mpg$cty, 
     xlab   = "Miles Per Gallon (City)", 
     main   = "Histogram of MPG (City)", 
     breaks = 12, 
     col    = "red",
     border = "blue")
```
]
.pull-right[
```{r,fig.height=4.5,eval=TRUE,echo=FALSE}
hist(mpg$cty, 
     xlab   = "Miles Per Gallon (City)", 
     main   = "Histogram of MPG (City)", 
     breaks = 12, col = "red",
     border = "blue")
```
]

---

# Looking for Outliers: Boxplots

.pull-left[
<br>
* An *Outlier* is a datapoint far removed from the center of a distribution.

* Boxplots are an effective way to check: Outliers are dots.

* The thick line is the median.

* The *box* typically denotes the interquartile range.

* see `?boxplot`
]

.pull-right[
```{r,fig.align='center',echo=FALSE,fig.height = 7}
# par(mar = lowtop)
boxplot(hwy ~ drv, data = mpg, xlab   = "Drivetrain (f = FWD, r = RWD, 4 = 4WD)", ylab   = "Miles Per Gallon (Highway)", main   = "MPG (Highway) vs Drivetrain", pch = 20,cex = 2,col ="red",border = "black")
# par(mar = om)
```
]

---

# Scatter Plots

* Two variables $x$ and $y$

--

* Natural to ask: How often do certain pairs of $(x_i,y_i)$ occur?
    ```{r}
    head(mpg[,c("hwy","displ")])
    ```
* That's what a scatter plots shows.

---

# Scatter Plots

.pull-left[
```{r,,fig.height=5,echo = FALSE}

par(mar = lowtop)
plot(hwy ~ displ, data = mpg)
par(mar = om)
```
]

.pull-right[
<br>
* Each dot is one pair $(x_i,y_i)$.

* We often call it one *observation*.

* Corresponding to one *row* of the data.frame.

* Why do some dots appear *darker* than others here?
]

---
class: inverse, middle


# It's Tutorial Time!

---

# Tutorial Chapter 2

Time for our first tutorial!! Type this into your `RStudio` console:

```{r,eval=FALSE}
library(ScPoEconometrics)
runTutorial('chapter2')
```

If you have trouble with the interactive doc, try this version (no interactive content):

```{r,eval=FALSE}
ScPoEconometrics::runTutorial('chapter2-script')
```

---

# How are x and y related? Covariance.

.pull-left[
```{r x-y-corr,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',fig.height = 6,fig.width=6}
library(mvtnorm)
set.seed(10)
cor = 0.9
sig = matrix(c(1,cor,cor,1),c(2,2))
ndat = data.frame(rmvnorm(n=300,sigma = sig))
x = ndat$X1
y = ndat$X2
par(pty="s")
par(mar = lowtop)
plot(x ~ y, xlab="x",ylab="y")
par(mar = om)

```
]

.pull-right[
<br><br><br>
* How are `x` and `y` related here?

* [This](https://scpoecon.github.io/ScPoEconometrics/sum.html#summarize-two) is the relevant section in the book about Covariance.

* This is **mandatory** reading.

]

---
class: inverse

# Correlation App

```{r,eval=FALSE}
library(ScPoEconometrics)
runTutorial('correlation')
```


---

# Intro do `dplyr`

.pull-left[
<br>
<br>
<br>
* [`dplyr`](https://dplyr.tidyverse.org) is part of the [tidyverse](https://www.tidyverse.org) package family.

* [`data.table`](https://github.com/Rdatatable/data.table/wiki) is another alternative. I use it *a lot* in research.

* Both have pros and cons. We'll start you off with `dplyr`. 
]

.pull-right[
![:scale 35%](../img/logo/dplyr.svg)

![:scale 35%](../img/logo/r-datatable.svg)
]

---

# `dplyr` Overview

.pull-left[
<br>
<br>
* You *must* read through [Hadley Wickham's chapter](https://r4ds.had.co.nz/transform.html). It's concise.

* The package is organized around a set of **verbs**, i.e. *actions* to be taken.

* We operate on `data.frames` or `tibbles` (*nicer looking* data.frames.)

* All *verbs*: First arg is a data.frame, subsequent args describe what to do, returns another data.frame.

]

--

.pull-right[

## Verbs

1. Choose observations based on a certain value (i.e. subset): `filter()`

1. Reorder rows: `arrange()`

1. Select variables by name: `select()`

1. Create new variables out of existing ones: `mutate()`

1. Summarise variables: `summarise()`
]

---

# R package `nycflights13`

```{r flights13}
library(nycflights13)
library(dplyr)
flights
```

`r emo::ji("rotating_light")` This is a `tibble` (more informative `data.frame`)

---

# Subset a data.frame with `filter()`

* `filter` has the same purpose than `subset`
* Which flights on 01/03/2013 departed between 5 and 6 AM with more than 10 minutes ahead of schedule?
    ```{r dplyr3,eval = FALSE}
    filter(flights, day == 1, month == 3, 
           dep_time >= 500 & dep_time <= 600, dep_delay < -5)
    ```
--
    ```{r dplyr4, echo = FALSE}
    filter(flights, day == 1, month == 3, 
           dep_time >= 500 & dep_time <= 600, dep_delay < -5)
    ```
   
  
---
# Create a Filter: Comparisons and Logical Ops

* We have standard suite of `>`, `<`, `>=`, `<=`, `!=`, `==`.

* Construct more complex filters with logical operators
    1. `x & y`: `x` **and** `y`
    1. `x | y`: `x` **or** `y`
    1. `!y`: **not** `y`

* `R` has the convenient `x %in% y` operator, `TRUE` if `x` is *a member of* `y`.
    ```{r}
    3 %in% 1:3
    c(2,5) %in% 2:10  # also vectorized
    c("S","Po") %in% c("Sciences","Po")  # also strings
    ```


---

# Missing Values: `NA`

.pull-left[
* Whenever a value is *missing*, we code it as `NA`.
    ```{r}
    x <- NA
    ```
* `R` propagates `NA` through operations:
    ```{r}
    NA > 5
    NA + 10
    ```
* the function `is.na(x)` returns `TRUE` if `x` is an `NA`.
    ```{r}
    is.na(x)
    ```


]

--

.pull-right[
* What is confusing is that 
    ```{r}
    NA == NA
    ```

* It's easy to illustrate like that:
    ```{r}
    # Let x be Mary's age. We don't know how old she is.
    x <- NA
    
    # Let y be John's age. We don't know how old he is.
    y <- NA
    
    # Are John and Mary the same age?
    x == y
    #> [1] NA
    # We don't know!
    ```

]


   
---
class: inverse

# Task 2.1


* You should read through [5.2.1](https://r4ds.had.co.nz/transform.html#filter-rows-with-filter) and learn more about *comparisons* and *logical operators*.

Then, find all flights that: 

1. Had an arrival delay of two or more hours

1. Flew to Houston (IAH or HOU)

1. Were operated by United, American, or Delta

1. Departed in summer (July, August, and September)

1. Arrived more than two hours late, but didn’t leave late

1. How many flights have a missing `dep_time`? What other variables are missing? What might these rows represent?

---

# `dplyr` Self Study

We can also 
1. *sort* a data.frame, 
1. *select* some columns from it, and 
1. add new columns.

For case study 1, you have to read those short sections yourself (click on function name):

1. [`arrange()`](https://r4ds.had.co.nz/transform.html#arrange-rows-with-arrange)

1. [`select()`](https://r4ds.had.co.nz/transform.html#select)

1. [`mutate()`](https://r4ds.had.co.nz/transform.html#add-new-variables-with-mutate)

---

# Split-Apply-Combine

.pull-left[
* Often we do *some* operation **by** some group in our dataset:
    * Mean height by sex.
    * Maximum income by age, etc

* For this, we need to 
    1. Split the data **by** `x`
    2. Apply to each chunk `xyz`
    3. Recombine all chunks
    
* in `dplyr`, that's `group_by()`.
]

--

.pull-right[
1. `group_by(x)` groups/splits `data.frame` by `x`:
    ```{r dplyr1}
    g = group_by(iris, Species)
    class(g)
    ```

1. `summarise` each chunk and re-combine
    ```{r dplyr2}
    summarise(
      g, mean_l = mean(Sepal.Length))
    ```
]

---
background-image: url("../img/logo/magrittr.svg")
background-position: 90% 5%
background-size: 180px

# Chaining `r emo::ji("link")` Commands Together: The Pipe

.pull-left[
<br>
<br>
* `magrittr` gives us the *pipe* `%>%`.

* This is like the UNIX pipe `|`: it passes arguments on.

* `x %>% f(y)` becomes `f(x,y)`.

* With the *pipe* you construct data *pipelines*.

]

.pull-right[
<br>
<br>
Our above example would become:
```{r pipe}
iris %>%
  group_by(Species) %>% 
  summarise(mean_l = mean(Sepal.Length))
```
which is equivalent to, but nicer than:
```{r,eval = FALSE}
summarise(
  group_by(iris, Species),
  mean_l = mean( Sepal.Length))
```
]


---
background-image: url("../img/logo/ggplot2.svg")
background-position: 90% 5%
background-size: 180px

# Quick `ggplot2` Intro

.pull-left[
<br>
<br>
* Excellent cheatsheet on [project website](https://ggplot2.tidyverse.org).

* We construct a `ggplot` in layers. We `+` add layers.

* In `aes` (aestethics) we say how data maps onto plot.

* We choose a `geom_` function to choose the geometry.
]

.pull-right[
<br>
<br>
```{r,fig.height = 4}
library(ggplot2)
ggplot(data = mpg,   # base layer
       mapping = aes(x = displ, y = hwy)) + 
   geom_point()   # add geom_ layer
```

]


---

# Quick `ggplot2` Intro

.pull-left[
<br>
<br>
* We can add more layers to this plot.

* We can map another variable to another feature, like color, size, shape etc.

* We could also add another `geom_` function.
]

.pull-right[
```{r,fig.height = 4}
ggplot(data = mpg,
       aes(x = displ, 
           y = hwy, 
           color = class)) +  # map `class` to color
   geom_point() 
```

]
---
class: title-slide-final, middle
background-image: url(../img/logo/ScPo-econ.png)
background-size: 250px
background-position: 9% 19%

# END




|                                                                                                            |                                   |
| :--------------------------------------------------------------------------------------------------------- | :-------------------------------- |
| <a href="mailto:florian.oswald@sciencespo.fr">.ScPored[<i class="fa fa-paper-plane fa-fw"></i>]               | florian.oswald@sciencespo.fr       |
| <a href="https://github.com/ScPoEcon/ScPoEconometrics-Slides">.ScPored[<i class="fa fa-link fa-fw"></i>] | Slides |
| <a href="https://scpoecon.github.io/ScPoEconometrics">.ScPored[<i class="fa fa-link fa-fw"></i>] | Book |
| <a href="http://twitter.com/ScPoEcon">.ScPored[<i class="fa fa-twitter fa-fw"></i>]                          | @ScPoEcon                         |
| <a href="http://github.com/ScPoEcon">.ScPored[<i class="fa fa-github fa-fw"></i>]                          | @ScPoEcon                       |

